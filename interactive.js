const results = [
    // [
    //     "0025",
    //     [
    //         "https://clementjambon.github.io/brepdiff_webvis/viser-client/",
    //         "?playbackPath=https://clementjambon.github.io/brepdiff_webvis/recordings/raw_traj/0025.viser",
    //         "&initialCameraPosition=0.0,-1.0,1.0",
    //         "&initialCameraLookAt=0.0,0.0,0.0",
    //         // "&baseSpeed=0.5",
    //         // "&darkMode",
    //     ],
    //     "./recordings/gen_14_1_16.png",
    //     ["./recordings/raw_traj/0025.mp4",
    //         "Generated B-rep"],
    //     "G"
    // ],
    [
        "0111",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0111.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0111.png",
        ["./recordings/generation/0111.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0133",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0133.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0133.png",
        ["./recordings/generation/0133.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0151",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0151.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0151.png",
        ["./recordings/generation/0151.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0347",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0347.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0347.png",
        ["./recordings/generation/0347.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0502",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0502.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0502.png",
        ["./recordings/generation/0502.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0590",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0590.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0590.png",
        ["./recordings/generation/0590.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0612",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0612.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0612.png",
        ["./recordings/generation/0612.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0686",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0686.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0686.png",
        ["./recordings/generation/0686.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0691",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0691.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0691.png",
        ["./recordings/generation/0691.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0698",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0698.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0698.png",
        ["./recordings/generation/0698.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0699",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0699.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0699.png",
        ["./recordings/generation/0699.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0723",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0723.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0723.png",
        ["./recordings/generation/0723.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0809",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0809.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0809.png",
        ["./recordings/generation/0809.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0816",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0816.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0816.png",
        ["./recordings/generation/0816.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0870",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0870.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0870.png",
        ["./recordings/generation/0870.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0900",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0900.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0900.png",
        ["./recordings/generation/0900.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0955",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0955.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0955.png",
        ["./recordings/generation/0955.mp4",
            "Generated B-rep"],
        "G"
    ],
    [
        "0989",
        [
            "/viser-client/",
            "?playbackPath=/recordings/generation/0989.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/generation/0989.png",
        ["./recordings/generation/0989.mp4",
            "Generated B-rep"],
        "G"
    ],
    // Interpolation
    [
        "interp_teaser",
        [
            "/viser-client/",
            "?playbackPath=/recordings/interpolation/teaser.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/interpolation/teaser_preview_square.png",
        ["./recordings/interpolation/teaser.png",
            "Interpolation"],
        "I"
    ],
    [
        "interp_fig12_1",
        [
            "/viser-client/",
            "?playbackPath=/recordings/interpolation/fig12_1.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/interpolation/fig12_1_preview_square.png",
        ["./recordings/interpolation/fig12_1.png",
            "Interpolation"],
        "I"
    ],
    [
        "interp_fig12_3",
        [
            "/viser-client/",
            "?playbackPath=/recordings/interpolation/fig12_3.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/interpolation/fig12_3_preview_square.png",
        ["./recordings/interpolation/fig12_3.png",
            "Interpolation"],
        "I"
    ],
    [
        "interp_fig12_4",
        [
            "/viser-client/",
            "?playbackPath=/recordings/interpolation/fig12_4.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/interpolation/fig12_4_preview_square.png",
        ["./recordings/interpolation/fig12_4.png",
            "Interpolation"],
        "I"
    ],
    // Auto Completion
    [
        "autocompletion_teaser",
        [
            "https://clementjambon.github.io/brepdiff_webvis/viser-client/",
            "?playbackPath=https://clementjambon.github.io/brepdiff_webvis/recordings/autocompletion/teaser.viser",
            "&initialCameraPosition=0.0,-1.0,1.0",
            "&initialCameraLookAt=0.0,0.0,0.0",
        ],
        "./recordings/gen_14_1_16.png",
        ["./recordings/raw_traj/0133.mp4",
            "Autocompleted B-rep"],
        "A"
    ],
];

function initializeResultSelector(resultsElement) {
    const selectorElement = resultsElement.querySelector(".results-selector");
    const resultsThumbnails = selectorElement.querySelector(
        ".results-thumbnails",
    );
    const prevButton = selectorElement.querySelector(".results-prev");
    const nextButton = selectorElement.querySelector(".results-next");
    let currentIndex = 0;

    function getExtension(filename) {
        const idx = filename.lastIndexOf('.');
        return idx >= 0 ? filename.slice(idx + 1) : '';
    }

    // ===================
    // IFRAME
    // ===================

    function createIframe(src) {
        const iframe = document.createElement("iframe");
        console.log("Creating iframe with src", src);
        iframe.src = src;
        return iframe;
    }

    function showIframe(src) {
        const wrapper = resultsElement.querySelector(".iframe-wrapper");
        wrapper.innerHTML = "";
        const iframe = createIframe(Array.isArray(src) ? src.join("") : src);
        wrapper.appendChild(iframe);
    }

    function hideIframe() {
        const wrapper = resultsElement.querySelector(".iframe-wrapper");
        wrapper.innerHTML = ""; // Remove iframe from DOM
    }

    // ===================
    // VIDEO
    // ===================

    function createVideo(src) {
        const video = document.createElement("video");
        console.log("Creating video with src", src);
        video.src = src;
        // video.controls = false; // No control
        // video.width = 250;
        video.autoplay = true;
        video.loop = true;
        video.playsInline = true;
        return video;
    }

    function createImage(src) {
        const image = document.createElement("img");
        console.log("Creating img with src", src);
        image.src = src;
        return image;
    }

    function showVideo(video_payload) {
        src = video_payload[0];
        caption = video_payload[1];
        if (getExtension(src) == "mp4") {
            const wrapper = resultsElement.querySelector(".video-wrapper");
            wrapper.innerHTML = "";
            const video = createVideo(Array.isArray(src) ? src.join("") : src);
            wrapper.appendChild(video);
        } else {
            const wrapper = resultsElement.querySelector(".video-wrapper");
            wrapper.innerHTML = "";
            const image = createImage(Array.isArray(src) ? src.join("") : src);
            wrapper.appendChild(image);
        }
        const video_caption = resultsElement.querySelector(".video-caption");
        video_caption.innerHTML = caption;
    }

    function hideVideo() {
        const wrapper = resultsElement.querySelector(".video-wrapper");
        wrapper.innerHTML = ""; // Remove iframe from DOM
    }

    function updateSelection(index) {
        if (currentIndex !== index) {
            hideIframe(); // Hide previous iframe
            hideVideo(); // Hide previous video
        }
        currentIndex = index;
        resultsThumbnails
            .querySelectorAll("a")
            .forEach((a, i) =>
                a.setAttribute("data-selected", i === index ? "true" : "false"),
            );

        const selectedThumbnail = resultsThumbnails.children[index];

        // Scroll the selected thumbnail into view
        const thumbnailsContainer = resultsThumbnails;
        const scrollLeft =
            selectedThumbnail.offsetLeft -
            (thumbnailsContainer.clientWidth - selectedThumbnail.clientWidth) / 2;
        thumbnailsContainer.scrollTo({
            left: scrollLeft,
            behavior: "smooth",
        });

        // Update URL with the selected result
        const resultName = results[index][0].toLowerCase().replace(/\s+/g, "-");
        const currentPath = window.location.pathname;
        const newUrl = `${currentPath}?result=${resultName}`;
        history.pushState(null, "", newUrl);

        showIframe(results[index][1]);
        showVideo(results[index][3])
    }

    results.forEach(([label, src, thumbnail, video_payload, tag], index) => {
        const link = document.createElement("a");
        link.href = "#";
        link.setAttribute("data-selected", index === 0 ? "true" : "false");
        link.addEventListener("click", (e) => {
            e.preventDefault();
            updateSelection(index);
        });

        const img = document.createElement("img");
        img.src = thumbnail;
        img.alt =
            "Thumbnail that can be clicked to show a result of our method: " + label;
        img.title = label;

        link.appendChild(img);

        const tag_div = document.createElement("div");
        tag_div.innerHTML = tag;
        // tag.style = "position: absolute; z-index: 2; top: 0.0; left: 0.0;";
        link.appendChild(tag_div);
        resultsThumbnails.appendChild(link);
    });

    prevButton.addEventListener("click", () => {
        updateSelection((currentIndex - 1 + results.length) % results.length);
    });

    nextButton.addEventListener("click", () => {
        updateSelection((currentIndex + 1) % results.length);
    });

    // Check URL for initial result selection
    const urlParams = new URLSearchParams(window.location.search);
    const initialResult = urlParams.get("result");
    console.log(results[0].length);
    if (initialResult) {
        const index = results.findIndex(
            (result) =>
                result[0].toLowerCase().replace(/\s+/g, "-") === initialResult,
        );
        if (index !== -1) {
            updateSelection(index);
        } else {
            showIframe(results[0][1]);
            showVideo(results[0][3])
        }
    } else {
        showIframe(results[0][1]);
        showVideo(results[0][3])
    }
}

// Initialize all result on the page
document.querySelectorAll(".results").forEach(initializeResultSelector);